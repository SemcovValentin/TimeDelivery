let allDishes = [];

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª—é–¥ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
async function loadAllDishes() {
    if (allDishes.length > 0) {
        return allDishes;
    }
    try {
        const response = await fetch("/timeDelivery/catalog", { credentials: 'include' });
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
        allDishes = await response.json();
        return allDishes;
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–ª—é–¥:", error);
        return [];
    }
}

// —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä
async function userIsAuthorized() {
    try {
        const response = await fetch('/timeDelivery/user/me', {
            credentials: 'include'
        });
        return response.ok;
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', e);
        return false;
    }
}



//////////////////////////////////////////////////////
// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞
function showUniversalToast(title, message, type = 'success') {
    const toastEl = document.getElementById('universalToast');
    const toastTitle = toastEl.querySelector('.toast-title');
    const toastBody = toastEl.querySelector('.toast-body');
    const toastHeader = toastEl.querySelector('.toast-header');

    // –°–±—Ä–æ—Å –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–ª–∞—Å—Å–æ–≤ –¥–ª—è —Ü–≤–µ—Ç–∞
    toastEl.classList.remove('bg-success', 'bg-info', 'bg-warning', 'bg-danger');
    toastHeader.classList.remove('bg-success', 'bg-info', 'bg-warning', 'bg-danger');
    toastEl.classList.add('bg-' + type);
    toastHeader.classList.add('bg-' + type);

    toastTitle.textContent = title;
    toastBody.textContent = message;

    const toast = new bootstrap.Toast(toastEl);
    toast.show();

    setTimeout(() => toast.hide(), 5000);
}
//–º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–∑–æ–≤–∞ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
function showAuthRequiredModal() {
    const modalEl = document.getElementById('authRequiredModal');
    const modal = new bootstrap.Modal(modalEl, {
        backdrop: 'static',
        keyboard: true
    });
    modal.show();
}



/////////////////////////////////////////////////////////

const carouselIndicators = document.getElementById('carouselExampleIndicators');
if (carouselIndicators) {
    //–∫–∞—Ä—É—Å–µ–ª—å
    fetch('/timeDelivery/images')
        .then(response => response.json())
        .then(images => {
            const carouselInner = document.getElementById('carouselInner');
            const carouselIndicators = document.getElementById('carouselIndicators');

            // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
            images.forEach((image, index) => {
                const indicator = document.createElement('button');
                indicator.type = 'button';
                indicator.dataset.bsTarget = '#carouselExampleIndicators';
                indicator.dataset.bsSlideTo = index;
                if (index === 0) {
                    indicator.classList.add('active');
                }
                indicator.ariaLabel = `Slide ${index + 1}`;
                carouselIndicators.appendChild(indicator);
            });

            // –°–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –∫–∞—Ä—É—Å–µ–ª–∏
            images.forEach((image, index) => {
                const carouselItem = document.createElement('div');
                carouselItem.classList.add('carousel-item');
                if (index === 0) {
                    carouselItem.classList.add('active');
                }

                const img = document.createElement('img');
                img.src = `/photos/news/${image}`;
                img.classList.add('d-block', 'w-100');
                img.alt = image;

                carouselItem.appendChild(img);
                carouselInner.appendChild(carouselItem);
            });
        })
        .catch(error => console.error('Error fetching images:', error));
}


////////////////////////////////////////////////////////////////
//–ø–µ—Ä–µ—Ö–æ–¥ –ø–æ –ø–æ–∏—Å–∫—É

const searchInput = document.querySelector('input[type="search"]');

if (searchInput) {
    searchInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') { // –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter
            event.preventDefault();
            const query = encodeURIComponent(searchInput.value.trim());
            if (query) {
                window.location.href = `/timeDelivery/search?query=${query}`;
            }
        }
    });
}

////////////////////////////////////////////////////////////
//–≤—ã–≤–æ–¥–∏—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤—ã–±–æ—Ä–∫–µ

document.addEventListener("DOMContentLoaded", () => {
    const catalog = document.getElementById("catalog");
    if (!catalog) {
        console.warn("–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å id 'catalog' –Ω–µ –Ω–∞–π–¥–µ–Ω, –∫–∞—Ç–∞–ª–æ–≥ –Ω–µ –±—É–¥–µ—Ç –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω.");
        return;
    }

    // –ü–æ–∏—Å–∫ –ø–æ id –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ (–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–æ–∏—Å–∫–∞ id –º–æ–∂–µ—Ç –±—ã—Ç—å catalogSearchInput, –Ω–∞ –¥—Ä—É–≥–∏—Ö - searchInput)
    const searchInput = document.getElementById("catalogSearchInput") || document.getElementById("searchInput");

    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param) || '';
    }

    function renderCards(dishes) {
        catalog.innerHTML = "";
        if (dishes.length === 0) {
            catalog.innerHTML = "<p>–ù–µ—Ç –±–ª—é–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>";
            return;
        }
        dishes.forEach(dish => {
            const cart = JSON.parse(localStorage.getItem('cart') || '{}');
            const count = cart[dish.id] || 0;
            const encodedImageUrl = '/photos' + encodeURI(dish.imageUrl);
            const card = document.createElement("div");
            card.className = "col-md-4 mb-4";
            card.innerHTML = `
            <div class="card h-100 d-flex flex-column">
                <div class="d-flex justify-content-center mb-3">
                    <img src="${encodedImageUrl}" class="card-img-top img-fluid" alt="${dish.name}" style="max-height: 200px; object-fit: contain;">
                </div>
                <div class="card-body d-flex flex-column justify-content-between flex-grow-1">
                    <h5 class="card-title">${dish.name}</h5>
                    <p class="card-text ingredient-text">${dish.ingredient}</p>
                    <div class="d-flex justify-content-between align-items-center mt-auto">
                        <h5 class="card-title">${dish.price} —Ä—É–±.</h5>
                        <p class="card-text">${dish.weight} –≥.</p>
                    </div>
                    <button type="button"
                        class="btn btn-warning w-100 mt-3 add-to-cart-btn position-relative"
                        data-dish-id="${dish.id}"
                        style="border-radius: 5px;">
                        –í –∫–æ—Ä–∑–∏–Ω—É üõí
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-count"
                              style="font-size: 0.95em; ${count > 0 ? '' : 'display:none;'}">
                            ${count > 99 ? '99+' : (count > 0 ? count : '')}
                            <span class="visually-hidden">—Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ</span>
                        </span>
                    </button>
                </div>
            </div>
        `;
            catalog.appendChild(card);
        });

        document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                const dishId = this.getAttribute('data-dish-id');
                let cart = JSON.parse(localStorage.getItem('cart') || '{}');
                cart[dishId] = (cart[dishId] || 0) + 1;
                localStorage.setItem('cart', JSON.stringify(cart));

                // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂
                const badge = this.querySelector('.cart-count');
                badge.style.display = 'inline-block';
                badge.textContent = cart[dishId] > 99 ? '99+' : cart[dishId];

                updateCartBadge();
                updateCardBadges();
            });
        });
    }

    function filterDishes() {
        const vegCheckbox = document.getElementById("btn-check-veg");
        const spicyCheckbox = document.getElementById("btn-check-spicy");
        const newCheckbox = document.getElementById("btn-check-new");
        const hitCheckbox = document.getElementById("btn-check-hit");

        const isVeganChecked = vegCheckbox ? !vegCheckbox.checked : false;
        const isSpicyChecked = spicyCheckbox ? !spicyCheckbox.checked : false;
        const isNewChecked = newCheckbox ? !newCheckbox.checked : false;
        const isTopChecked = hitCheckbox ? !hitCheckbox.checked : false;

        const searchValue = searchInput ? searchInput.value.trim().toLowerCase() : '';

        let filtered = allDishes;

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –µ—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä –µ—Å—Ç—å
        const categoryParam = getQueryParam("category");
        if (categoryParam) {
            const currentCategory = categoryParam.toLowerCase();
            filtered = filtered.filter(dish => {
                if (!dish.typeDishes || dish.typeDishes.length === 0) return false;
                return dish.typeDishes.some(cat => cat.name.toLowerCase() === currentCategory);
            });
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–∏—Å–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ –∏ –∑–Ω–∞—á–µ–Ω–∏–µ)
        if (searchValue) {
            filtered = filtered.filter(dish => dish.name.toLowerCase().includes(searchValue));
        } else {
            // –ï—Å–ª–∏ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—É—Å—Ç–æ–µ, –Ω–æ –≤ URL –µ—Å—Ç—å query - —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –Ω–µ–º—É
            const queryParam = getQueryParam("query");
            if (queryParam) {
                filtered = filtered.filter(dish => dish.name.toLowerCase().includes(queryParam.toLowerCase()));
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —á–µ–∫–±–æ–∫—Å–∞–º
        filtered = filtered.filter(dish => {
            if (isVeganChecked && !dish.vegan) return false;
            if (isSpicyChecked && !dish.spicy) return false;
            if (isNewChecked && !dish.new) return false;
            if (isTopChecked && !dish.top) return false;
            return true;
        });

        renderCards(filtered);
    }

    function debounce(fn, delay) {
        let timeoutId;
        return function (...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    function initFilters() {
        ["btn-check-veg", "btn-check-spicy", "btn-check-new", "btn-check-hit"].forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) {
                checkbox.addEventListener("change", filterDishes);
            }
        });
    }

    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä query, –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤ –ø–æ–ª–µ
    const initialQuery = getQueryParam('query');
    if (initialQuery && searchInput) {
        searchInput.value = initialQuery;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –±–ª—é–¥ —á–µ—Ä–µ–∑ –∫–µ—à–∏—Ä—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
    loadAllDishes()
        .then(() => {
            initFilters();
            filterDishes();
        })
        .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:", error));

    if (searchInput) {
        const debouncedFilter = debounce(filterDishes, 300);
        searchInput.addEventListener("input", debouncedFilter);
    }
});


///////////////////////////////////////////////////////////////////////////////////
//scroll menu, –∫–æ—Ç–æ—Ä–∞—è —Å–ª–µ–¥—É–µ—Ç –∑–∞ —ç–∫—Ä–∞–Ω–æ–º
/*let lastScrollTop = 0;

window.addEventListener("scroll", () => {
    let scrollTop = window.scrollY;
    let scrollMenu = document.querySelector(".scroll-menu");

    if (scrollTop > lastScrollTop) {
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        if (scrollTop > 150) { // –ü–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –Ω–∞ 200 –ø–∏–∫—Å–µ–ª–µ–π
            scrollMenu.style.display = "block"; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
            scrollMenu.classList.remove("hide");
            scrollMenu.classList.add("show");
        }
    } else {
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö
        if (scrollTop < 150) { // –ò—Å—á–µ–∑–∞–µ—Ç –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –¥–æ 100 –ø–∏–∫—Å–µ–ª–µ–π –æ—Ç –≤–µ—Ä—Ö–∞
            scrollMenu.classList.remove("show");
            scrollMenu.classList.add("hide");
            scrollMenu.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
        }
    }

    lastScrollTop = scrollTop;
});*/

// –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ 20 –ø–∏–∫—Å–µ–ª–µ–π –≤–Ω–∏–∑ –æ—Ç –µ–≥–æ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏, –ø–æ–∫–∞–∂–∏—Ç–µ –∫–Ω–æ–ø–∫—É
/*window.onscroll = function () {
    scrollFunction()
};

function scrollFunction() {
    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
        scrollToTopBtn.classList.add("show");
    } else {
        scrollToTopBtn.classList.remove("show");
    }
}

// –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É, –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç—Å—è –¥–æ –Ω–∞—á–∞–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞.
const scrollToTopBtn = document.getElementById('scrollToTopBtn');

if (scrollToTopBtn) {
    scrollToTopBtn.addEventListener("click", function () {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
    });
}*/
document.addEventListener('DOMContentLoaded', () => {
    const scrollMenu = document.querySelector(".scroll-menu");
    if (!scrollMenu) return;

    let lastScrollTop = 0;

    window.addEventListener("scroll", () => {
        let scrollTop = window.scrollY;

        if (scrollTop > lastScrollTop) {
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            if (scrollTop > 150) {
                scrollMenu.style.display = "block";
                scrollMenu.classList.remove("hide");
                scrollMenu.classList.add("show");
            }
        } else {
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö
            if (scrollTop < 150) {
                scrollMenu.classList.remove("show");
                scrollMenu.classList.add("hide");
                scrollMenu.style.display = "none";
            }
        }

        lastScrollTop = scrollTop;
    });
});


document.addEventListener('DOMContentLoaded', () => {
    const scrollToTopBtn = document.getElementById('scrollToTopBtn');

    if (!scrollToTopBtn) return;

    window.addEventListener('scroll', () => {
        if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
            scrollToTopBtn.classList.add('show');
        } else {
            scrollToTopBtn.classList.remove('show');
        }
    });

    scrollToTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
});


///////////////////////////////////////////////////////////
//—Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫–æ—Ä–∑–∏–Ω—ã
function renderCartTable(dishes) {
    const cart = JSON.parse(localStorage.getItem('cart') || '{}');
    let total = 0;
    let rows = '';

    Object.keys(cart).forEach(dishId => {
        const dish = dishes.find(d => d.id == dishId);
        const encodedImageUrl = '/photos' + encodeURI(dish.imageUrl);
        if (!dish) return;
        const count = cart[dishId];
        const sum = dish.price * count;
        total += sum;
        rows += `
    <tr>
        <td>
            <a href="/timeDelivery/search?query=${encodeURIComponent(dish.name)}" target="_blank">
                <img src="${encodedImageUrl}" alt="${dish.name}" style="width:60px; height:40px; object-fit:cover;">
            </a>
        </td>
        <td>
            <a href="/timeDelivery/search?query=${encodeURIComponent(dish.name)}" class="text-warning" style="text-decoration: underline;" target="_blank">
                ${dish.name}
            </a>
        </td>
        <td>${dish.price} —Ä—É–±.</td>
        <td>
            <button class="btn btn-sm btn-outline-warning cart-minus" data-dish-id="${dish.id}">-</button>
            <span class="mx-2">${count}</span>
            <button class="btn btn-sm btn-outline-warning cart-plus" data-dish-id="${dish.id}">+</button>
        </td>
        <td>${sum} —Ä—É–±.</td>
        <td>
            <button class="btn btn-sm btn-outline-danger cart-remove" data-dish-id="${dish.id}">‚úñ</button>
        </td>
    </tr>
`;
    });

    if (!rows) {
        document.getElementById('cartTableContainer').innerHTML = '<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
        return;
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –µ—Å–ª–∏ –µ—Å—Ç—å
    const savedComment = localStorage.getItem('cartComment') || '';

    document.getElementById('cartTableContainer').innerHTML = `
        <table class="table table-dark table-striped align-middle mb-3">
            <thead>
                <tr>
                    <th></th>
                    <th>–ë–ª—é–¥–æ</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–ö–æ–ª-–≤–æ</th>
                    <th>–°—É–º–º–∞</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
            <tfoot>
                <tr>
                    <td colspan="4" class="text-end"><b>–ò—Ç–æ–≥–æ:</b></td>
                    <td colspan="2"><b>${total} —Ä—É–±.</b></td>
                </tr>
            </tfoot>
        </table>
        <div class="mb-3">
            <label for="cartComment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É:</label>
            <textarea id="cartComment" class="form-control" rows="2" placeholder="–£—Ç–æ—á–Ω–µ–Ω–∏—è –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ, –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏ —Ç.–¥.">${savedComment}</textarea>
        </div>
    `;
}

//–í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ "+" –∏ "-" –∏ "‚úñ" –≤ –∫–æ—Ä–∑–∏–Ω–µ
document.getElementById('cartTableContainer').addEventListener('click', function (e) {
    const cart = JSON.parse(localStorage.getItem('cart') || '{}');
    if (e.target.classList.contains('cart-plus')) {
        const id = e.target.getAttribute('data-dish-id');
        cart[id] = (cart[id] || 0) + 1;
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCartTable(allDishes);
        updateCartBadge();
        updateCardBadges()
    }
    if (e.target.classList.contains('cart-minus')) {
        const id = e.target.getAttribute('data-dish-id');
        cart[id] = (cart[id] || 1) - 1;
        if (cart[id] <= 0) {
            delete cart[id];
        } else {
        }
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCartTable(allDishes);
        updateCartBadge();
        updateCardBadges()
    }
    if (e.target.classList.contains('cart-remove')) {
        const id = e.target.getAttribute('data-dish-id');
        delete cart[id];
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCartTable(allDishes);
        updateCartBadge();
        updateCardBadges()
    }
});

//—Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–µ–Ω—Ç –≤ localStorage
document.addEventListener('input', function(e) {
    if (e.target && e.target.id === 'cartComment') {
        localStorage.setItem('cartComment', e.target.value);
    }
});

//–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–π–¥–∂–∞ –Ω–∞ –∫–Ω–æ–ø–∫–µ –∫–æ—Ä–∑–∏–Ω—ã
function updateCartBadge() {
    const cart = JSON.parse(localStorage.getItem('cart') || '{}');
    let total = Object.values(cart).reduce((sum, n) => sum + n, 0);
    document.querySelectorAll('.cart-badge').forEach(badge => {
        if (total > 0) {
            badge.style.display = 'inline-block';
            badge.textContent = total > 99 ? '99+' : total;
        } else {
            badge.style.display = 'none';
        }
    });
}

document.querySelectorAll('.cart-btn').forEach(btn => {
    btn.addEventListener('click', function (e) {
        e.preventDefault();
        const cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
        cartModal.show();
    });
});

document.addEventListener('DOMContentLoaded', function () {
    updateCartBadge();
    updateCardBadges();
});

document.getElementById('cartModal').addEventListener('show.bs.modal', function () {
    renderCartTable(allDishes);
});

document.getElementById('cartModal').addEventListener('hide.bs.modal', () => {
    if (document.activeElement instanceof HTMLElement) {
        document.activeElement.blur();
    }
});



//–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–π–¥–∂–µ–π –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
function updateCardBadges() {
    const cart = JSON.parse(localStorage.getItem('cart') || '{}');
    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        const dishId = btn.getAttribute('data-dish-id');
        const badge = btn.querySelector('.cart-count');
        const count = cart[dishId] || 0;
        if (count > 0) {
            badge.style.display = 'inline-block';
            badge.textContent = count > 99 ? '99+' : count;
        } else {
            badge.style.display = 'none';
        }
    });
}

// –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
document.getElementById('submitOrderBtn').addEventListener('click', async function() {
    const cart = JSON.parse(localStorage.getItem('cart') || '{}');
    const comment = document.getElementById('cartComment')?.value || '';

    // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    if (!(await userIsAuthorized())) {
        showAuthRequiredModal();
        return;
    }

    if (Object.keys(cart).length === 0) {
        showUniversalToast('–û—à–∏–±–∫–∞', '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', 'danger');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–ª—é–¥
    const dishIds = Object.keys(cart);
    const missingDishes = dishIds.filter(id => !allDishes.find(d => d.id == id));
    if (missingDishes.length > 0) {
        showUniversalToast('–û—à–∏–±–∫–∞', '–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –±–ª—é–¥–∞ –±–æ–ª—å—à–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –∫–æ—Ä–∑–∏–Ω—É.', 'danger');
        missingDishes.forEach(id => delete cart[id]);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCartTable(allDishes);
        updateCartBadge();
        updateCardBadges();
        return;
    }

    try {
        const response = await fetch('/timeDelivery/orders/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ items: cart, comment }), // <-- –¥–æ–±–∞–≤–∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
            redirect: 'manual'
        });

        if (response.status === 401 || response.status === 403) {
            showAuthRequiredModal();
            throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        }

        if (!response.ok) {
            let errorData;
            try {
                errorData = await response.json();
            } catch {
                errorData = {};
            }
            throw new Error(errorData.error || '–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞');
        }

        const data = await response.json();

        // –£—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–∏–ª–∏ –∑–∞–∫–∞–∑
        localStorage.removeItem('cart');
        localStorage.removeItem('cartComment');
        renderCartTable(allDishes);
        updateCartBadge();
        updateCardBadges();

        const orderId = data.orderId || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
        showUniversalToast('–£—Å–ø–µ—Ö', '–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: ' + orderId, 'success');

        const cartModalEl = document.getElementById('cartModal');
        const modalInstance = bootstrap.Modal.getInstance(cartModalEl);
        if (modalInstance) {
            modalInstance.hide();
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:', error);
        showUniversalToast('–û—à–∏–±–∫–∞', error.message, 'danger');
    }
});






