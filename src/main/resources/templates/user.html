<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Страница пользователя</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
</head>
<body>
<h1>User page</h1>

<button id="logoutBtn" class="btn btn-danger">Выйти</button>

<div class="container mt-3">
    <!-- Левый верхний угол - две кнопки -->
    <div class="d-flex justify-content-start mb-3">
        <button class="btn btn-primary me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasUserEdit" aria-controls="offcanvasUserEdit">
            Редактировать безопасность
        </button>
        <button class="btn btn-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasClientEdit" aria-controls="offcanvasClientEdit">
            Редактировать личные данные
        </button>
    </div>


    <!-- Offcanvas для редактирования user-->
    <div class="offcanvas offcanvas-start" data-bs-scroll="true" tabindex="-1" id="offcanvasUserEdit" aria-labelledby="offcanvasUserEditLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasUserEditLabel">Редактирование User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
        </div>
        <div class="offcanvas-body">
            <form id="userEditForm">
                <div class="mb-3">
                    <label for="userNameInput" class="form-label">Телефон:</label>
                    <input type="text" class="form-control" id="userNameInput" name="name" required />
                </div>
                <div class="mb-3">
                    <label for="userPasswordInput" class="form-label">Пароль:</label>
                    <input type="password" class="form-control" id="userPasswordInput" name="password" minlength="6" />
                    <div class="form-text">Оставьте пустым, если не хотите менять пароль</div>
                </div>
                <button type="submit" class="btn btn-success">Сохранить</button>
            </form>
        </div>
    </div>

    <!-- Offcanvas для редактирования client-->
    <div class="offcanvas offcanvas-start" data-bs-scroll="true" tabindex="-1" id="offcanvasClientEdit" aria-labelledby="offcanvasClientEditLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasClientEditLabel">Редактирование Client</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
        </div>
        <div class="offcanvas-body">
            <form id="clientEditForm">
                <div class="mb-3">
                    <label for="clientEmailInput" class="form-label">Email</label>
                    <input type="email" class="form-control" id="clientEmailInput" name="email" required />
                </div>
                <div class="mb-3">
                    <label for="clientAddressInput" class="form-label">Адрес</label>
                    <input type="text" class="form-control" id="clientAddressInput" name="address" />
                </div>
                <div class="mb-3">
                    <label for="clientCityInput" class="form-label">Город</label>
                    <input type="text" class="form-control" id="clientCityInput" name="city" />
                </div>
                <div class="mb-3">
                    <label for="clientBirthdayInput" class="form-label">Дата рождения</label>
                    <input type="date" class="form-control" id="clientBirthdayInput" name="birthday" />
                </div>
                <button type="submit" class="btn btn-success">Сохранить</button>
            </form>
        </div>
    </div>


</div>


<script>

    //кнопка выхода
    document.getElementById('logoutBtn').addEventListener('click', () => {
        // Удаляем JWT токен из localStorage или sessionStorage
        localStorage.removeItem('token');
        // Перенаправляем на страницу входа или главную
        window.location.href = '/timeDelivery/'; // или '/'
    });

    ///////////////////////////////
    const token = localStorage.getItem('token');

    document.getElementById('offcanvasUserEdit').addEventListener('show.bs.offcanvas', async () => {
        try {
            const res = await fetch('/timeDelivery/user/me', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!res.ok) throw new Error('Ошибка загрузки User данных');
            const user = await res.json();

            // Предполагаем, что user содержит name и не содержит пароль
            document.getElementById('userNameInput').value = user.name || '';
            document.getElementById('userPasswordInput').value = '';
        } catch (e) {
            alert(e.message);
        }
    });

    document.getElementById('offcanvasClientEdit').addEventListener('show.bs.offcanvas', async () => {
        try {
            const res = await fetch('/timeDelivery/me', { // предположим, отдельный эндпоинт для client
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!res.ok) throw new Error('Ошибка загрузки Client данных');
            const client = await res.json();

            document.getElementById('clientEmailInput').value = client.email || '';
            document.getElementById('clientAddressInput').value = client.address || '';
            document.getElementById('clientCityInput').value = client.city || '';
            document.getElementById('clientBirthdayInput').value = client.birthday || '';
        } catch (e) {
            alert(e.message);
        }
    });

    document.getElementById('userEditForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('userNameInput').value.trim();
        const password = document.getElementById('userPasswordInput').value;

        const payload = { name };
        if (password.length >= 6) payload.password = password;

        try {
            const res = await fetch('/user/updateUser', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Ошибка обновления User');
            alert('User данные обновлены');
            bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasUserEdit')).hide();
        } catch (e) {
            alert(e.message);
        }
    });

    document.getElementById('clientEditForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = document.getElementById('clientEmailInput').value.trim();
        const address = document.getElementById('clientAddressInput').value.trim();
        const city = document.getElementById('clientCityInput').value.trim();
        const birthday = document.getElementById('clientBirthdayInput').value;

        const payload = { email, address, city, birthday };

        try {
            const res = await fetch('/user/updateClient', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Ошибка обновления Client');
            alert('Client данные обновлены');
            bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasClientEdit')).hide();
        } catch (e) {
            alert(e.message);
        }
    });


</script>

</body>
</html>