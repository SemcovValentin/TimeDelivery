<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Страница пользователя</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
            crossorigin="anonymous"></script>
</head>
<style>
    /* форма входа и регистрации */
    .offcanvas {
        background-color: #222;
        color: #888;
        border-left: 1px solid #444;
    }

    .auth-form {
        max-width: 400px;
        margin: 2rem auto;
        padding: 2rem;
        background: #2a2a2a;
        border-radius: 1rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.2);
        color: #999;
        border: 1px solid #444;
    }

    .auth-switcher .btn-group {
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.2);
        border-radius: 0.75rem;
        overflow: hidden;
    }

    .auth-switcher .btn {
        border: none;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .auth-switcher .btn:not(.active) {
        background: #333;
        color: #f8f9fa;
    }

    .auth-switcher .btn.active {
        background: #0d6efd;
        color: #fff;
    }

    .form-control {
        background: #333;
        border: 1px solid #444;
        color: #f8f9fa;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .form-control:focus {
        background: #444;
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        color: #fff;
    }

    .form-control::placeholder {
        color: #eee; /* почти белый */
        opacity: 1;
    }

    .form-group label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #f8f9fa;
    }

    .toast {
        border-radius: 0.75rem;
    }

    .toast-header {
        border-radius: 0.75rem 0.75rem 0 0;
    }

    @media (max-width: 576px) {
        .auth-form {
            padding: 1.5rem;
        }
    }

    .toast {
        border-radius: 0.75rem;
        background: #2a2a2a;
        border: 1px solid #444;
        color: #eee;
    }

    .toast-header {
        border-radius: 0.75rem 0.75rem 0 0;
        background: #333;
        color: #eee;
        border-bottom: 1px solid #444;
    }

    .toast-body {
        background: #2a2a2a;
        color: #888;
    }

    /*футер*/
    .footer-bg {
        background-color: #222;
        width: 100%;
    }

    .footer-bg h5 {
        color: #ff9900;
        margin-bottom: 0.5rem;
    }

    .footer-text {
        color: #ccc;
        font-size: 0.97rem;
        margin-bottom: 0.5rem;
        text-decoration: none;
    }

    .footer .btn-footer {
        width: fit-content;
        align-self: flex-start;
    }

    a.footer-text:hover {
        color: #ff9900;
        text-decoration: underline;
    }

    .footer-text:hover {
        color: #ff9900;
    }

    body {
        font-family: "Times New Roman", Times, serif;
    }

    .custom-card {
        background-color: #222;
        color: #eee;
        border: 1px solid #444;
        border-radius: 1rem;
    }

    .custom-card .card-title {
        color: #ffd700;
        font-size: 1.2rem;
    }

    .btn-footer {
        border-radius: 0.5rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        font-size: 1.15rem; /* увеличенный размер шрифта */
    }

    .btn-outline-warning {
        color: #ffc107;
        border-color: #ffc107;
        background-color: transparent;
        transition: all 0.2s;
    }

    .btn-outline-warning:hover {
        background-color: #ffc107;
        color: #222;
        border-color: #ffc107;
    }

    .btn-outline-danger {
        color: #ff6b6b;
        border-color: #ff6b6b;
        background-color: transparent;
        transition: all 0.2s;
    }

    .btn-sm {
        padding: 0.25rem 0.75rem;
        font-size: 0.9rem;
    }

    /* Правая колонка - таблица заказов */
    .flex-grow-1 {
        background-color: #222; /* основной тёмный фон */
        border-radius: 8px;
        padding: 1rem 1.5rem;
        color: #eee;
        overflow-y: auto;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }

    /* Заголовок */
    .flex-grow-1 h2 {
        color: #ccc;
        font-weight: 700;
        margin-bottom: 1.5rem;
        user-select: none;
    }

    /* Таблица заказов */
    .flex-grow-1 table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 0.75rem; /* отступы между строками */
        background-color: #2f2f2f; /* чуть светлее основного фона */
        border-radius: 8px;
        overflow: hidden;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.7);
    }

    /* Переопределение Bootstrap классов для тёмной темы */
    .flex-grow-1 .table {
        background-color: #2f2f2f !important;
        color: #eee !important;
    }

    /* Заголовки таблицы */
    .flex-grow-1 .table thead th {
        background-color: #3a3a3a !important;
        color: #eee !important; /* заменили на светло-серый/белый */
        font-weight: 600;
        padding: 0.75rem 1rem;
        text-align: left;
        user-select: none;
        text-shadow: none; /* можно убрать тень для чистоты */
    }

    /* Чёрный текст в строках с товарами */
    .flex-grow-1 .table-striped > tbody > tr:nth-of-type(odd),
    .flex-grow-1 .table-striped > tbody > tr:nth-of-type(even),
    .flex-grow-1 .table tbody tr {
        background-color: #444 !important;
        color: #000 !important; /* Чёрный текст */
        border-radius: 6px;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .flex-grow-1 .table tbody tr:hover {
        background-color: #666 !important;
        color: #000 !important; /* Чёрный текст при ховере */
    }

    /* Заголовок */
    .flex-grow-1 table.table thead th {
        background-color: #3a3a3a !important;
        color: #ccc !important;
    }

    /* Ячейки с чёрным текстом */
    .flex-grow-1 table.table tbody td {
        padding: 0.75rem 1rem;
        vertical-align: middle;
        color: #000 !important; /* Чёрный текст */
        border-top: 1px solid #444 !important;
        transition: color 0.3s ease;
    }


    /* Цвет текста при ховере по строке */
    .flex-grow-1 .table tbody tr:hover td {
        color: #000 !important; /* Чёрный текст при ховере */
    }

    /* Ссылки в ячейках */
    .flex-grow-1 table.table tbody td a {
        color: black;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .flex-grow-1 table.table tbody td a:hover {
        color: #ccc !important; /* чуть светлее при ховере */
    }

    /* Нижняя строка с итогом */
    .flex-grow-1 tfoot td {
        padding: 1rem;
        font-weight: 700;
        color: #eee;
        border-top: 2px solid #555;
        background-color: #3a3a3a;
        text-shadow: none;
    }

    /* Сообщение об отсутствии заказов */
    #userOrdersEmptyMessage {
        font-size: 1.2rem;
        margin-top: 3rem;
        color: #bbb;
        user-select: none;
    }

    /* Скроллбар для правой колонки */
    .flex-grow-1::-webkit-scrollbar {
        width: 8px;
    }

    .flex-grow-1::-webkit-scrollbar-track {
        background: #1a1a1a;
        border-radius: 4px;
    }

    .flex-grow-1::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
    }

    /* Скроллбар при ховере */
    .flex-grow-1::-webkit-scrollbar-thumb:hover {
        background-color: #ccc;
    }

    /* Адаптивность */
    @media (max-width: 768px) {
        .container > .d-flex {
            flex-direction: column;
            height: auto;
        }

        .custom-card {
            width: 100% !important;
            margin-bottom: 1rem;
        }

        .flex-grow-1 {
            max-height: none;
            overflow-y: visible;
            padding: 1rem;
        }
    }

    .flex-grow-1 table {
        font-size: 1.2rem;
    }

    .order-number {
        font-size: 1.20rem;
        font-weight: 600;
    }

</style>
<body>
<h1>Добро пожаловать!</h1>

<div class="container" style="height: 700px">
    <div class="d-flex h-100">
        <!-- Левая колонка: меню -->
        <div class="card mb-3 custom-card" style="width: 18rem;">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 id="clientName">Имя пользователя</h5>
                    <button id="logoutBtn" class="btn btn-outline-danger btn-sm ms-2">Выйти</button>
                </div>
                <div class="d-grid gap-2 mb-2">
                    <button id="BackBtn" class="btn btn-outline-warning btn-footer"
                            onclick="window.location.href='/timeDelivery/'">Назад
                    </button>
                    <button class="btn btn-outline-warning btn-footer" type="button" data-bs-toggle="offcanvas"
                            data-bs-target="#offcanvasUserEdit" aria-controls="offcanvasUserEdit">
                        Безопасность
                    </button>
                    <button class="btn btn-outline-warning btn-footer" type="button" data-bs-toggle="offcanvas"
                            data-bs-target="#offcanvasClientEdit" aria-controls="offcanvasClientEdit">
                        Контактные данные
                    </button>
                    <a href="#" class="btn btn-outline-warning btn-footer position-relative cart-btn"
                       data-bs-toggle="modal" data-bs-target="#cartModal">
                        <i class="bi bi-cart me-1"></i>КОРЗИНА
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-badge" style="display:none;">
                                 0
                            <span class="visually-hidden">товаров в корзине</span>
                        </span>
                    </a>


                </div>
            </div>
        </div>

        <!-- Модальное окно корзины -->
        <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content" style="background-color: #222; color: #eee;">
                    <div class="modal-header">
                        <h5 class="modal-title" id="cartModalLabel">Ваш заказ</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Закрыть"></button>
                    </div>
                    <div class="modal-body">
                        <div id="cartTableContainer"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="submitOrderBtn" class="btn btn-success">
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"
                                  style="display: none;"></span>
                            Оформить заказ
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Правая колонка: таблица заказов -->
        <div class="flex-grow-1 ms-4 overflow-auto" style="max-height: 700px;">
            <h2 class="mb-4">Мои заказы</h2>
            <div id="userOrdersTableContainer">
            </div>
            <div id="userOrdersEmptyMessage" class="text-center text-muted" style="display:none;">
                У вас пока нет заказов.
            </div>
        </div>
    </div>
</div>


<div class="container mt-3">
    <!-- Offcanvas для редактирования пользователя -->
    <div class="offcanvas offcanvas-start" data-bs-scroll="true" tabindex="-1" id="offcanvasUserEdit"
         aria-labelledby="offcanvasUserEditLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasUserEditLabel">Безопасность</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
        </div>
        <div class="offcanvas-body">
            <form id="userEditForm" class="auth-form" novalidate>
                <div class="mb-3">
                    <label for="userPhoneInput" class="form-label">Телефон:</label>
                    <input type="text" class="form-control" id="userPhoneInput" name="phone" required/>
                </div>
                <div class="mb-3">
                    <label for="userPasswordCurrent" class="form-label">Текущий пароль:</label>
                    <input type="password" class="form-control" id="userPasswordCurrent" name="currentPassword"
                           minlength="6" required/>
                </div>
                <div class="mb-3">
                    <label for="userPasswordNew" class="form-label">Новый пароль:</label>
                    <input type="password" class="form-control" id="userPasswordNew" name="newPassword"
                           minlength="6"/>
                </div>
                <div class="mb-3">
                    <label for="userPasswordNewCheck" class="form-label">Повторите новый пароль:</label>
                    <input type="password" class="form-control" id="userPasswordNewCheck" name="newPasswordCheck"
                           minlength="6"/>
                </div>
                <button type="submit" class="btn btn-success">Сохранить</button>
            </form>
        </div>
    </div>

    <!-- Offcanvas для редактирования client-->
    <div class="offcanvas offcanvas-start" data-bs-scroll="true" tabindex="-1" id="offcanvasClientEdit"
         aria-labelledby="offcanvasClientEditLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasClientEditLabel">Контактные данные</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
        </div>
        <div class="offcanvas-body">
            <form id="clientEditForm" class="auth-form">
                <div class="mb-3 form-group">
                    <label for="clientNameInput" class="form-label">Имя</label>
                    <input type="text" class="form-control" id="clientNameInput" name="name" required/>
                </div>
                <div class="mb-3 form-group">
                    <label for="clientEmailInput" class="form-label">Email</label>
                    <input type="email" class="form-control" id="clientEmailInput" name="email" required/>
                </div>
                <div class="mb-3 form-group">
                    <label for="clientAddressInput" class="form-label">Адрес</label>
                    <input type="text" class="form-control" id="clientAddressInput" name="address"/>
                </div>
                <div class="mb-3 form-group">
                    <label for="clientCityInput" class="form-label">Город</label>
                    <input type="text" class="form-control" id="clientCityInput" name="city"/>
                </div>
                <div class="mb-3 form-group">
                    <label for="clientBirthdayInput" class="form-label">Дата рождения</label>
                    <input type="date" class="form-control" id="clientBirthdayInput" name="birthday"/>
                </div>
                <button type="submit" class="btn btn-success">Сохранить</button>
            </form>
        </div>
    </div>

    <div id="universalToast"
         class="toast align-items-center text-white bg-success border-0 position-fixed bottom-0 end-0 m-3" role="alert"
         aria-live="assertive" aria-atomic="true" style="min-width: 250px; z-index: 1080;">
        <div class="toast-header bg-success text-white">
            <strong class="me-auto toast-title">Заголовок</strong>
            <button type="button" class="btn-close btn-close-white ms-2 mb-1" data-bs-dismiss="toast"
                    aria-label="Закрыть"></button>
        </div>
        <div class="toast-body toast-body">
            Сообщение
        </div>
    </div>


</div>


<script>

    async function loadAllDishes() {
        try {
            const response = await fetch('/timeDelivery/catalog', {credentials: 'include'});
            if (!response.ok) {
                throw new Error('Ошибка загрузки блюд');
            }
            const dishes = await response.json();
            return dishes;
        } catch (error) {
            console.error('Ошибка при загрузке блюд:', error);
            return [];
        }
    }

    // Универсальная функция показа Toast
    function showUniversalToast(title, message, type = 'success') {
        const toastEl = document.getElementById('universalToast');
        if (!toastEl) {
            console.error('Toast элемент с id "universalToast" не найден');
            return;
        }

        const toastTitle = toastEl.querySelector('.toast-title');
        const toastBody = toastEl.querySelector('.toast-body');
        const toastHeader = toastEl.querySelector('.toast-header');

        toastEl.classList.remove('bg-success', 'bg-info', 'bg-warning', 'bg-danger');
        toastHeader.classList.remove('bg-success', 'bg-info', 'bg-warning', 'bg-danger');

        toastEl.classList.add('bg-' + type);
        toastHeader.classList.add('bg-' + type);

        toastTitle.textContent = title;
        toastBody.textContent = message;

        const toast = new bootstrap.Toast(toastEl);
        toast.show();

        setTimeout(() => toast.hide(), 5000);
    }

    // Например, если client.name хранится в localStorage:
    document.getElementById('clientName').textContent = localStorage.getItem('clientName') || 'Имя пользователя';

    // Или если получаете с сервера:
    fetch('/timeDelivery/me', {
        headers: {'Authorization': 'Bearer ' + localStorage.getItem('token')}
    })
        .then(res => res.json())
        .then(client => {
            document.getElementById('clientName').textContent = client.name || 'Имя пользователя';
        });


    //кнопка выхода
    document.getElementById('logoutBtn').addEventListener('click', async function (e) {
        e.preventDefault();
        try {
            // Вызов серверного logout для удаления httpOnly cookie
            await fetch('/timeDelivery/logout', {method: 'POST', credentials: 'include'});
        } catch (err) {
            // Можно обработать ошибку, если нужно
            console.error('Ошибка при выходе:', err);
        }
        // Очищаем localStorage
        localStorage.removeItem('token');
        localStorage.removeItem('roles');
        localStorage.removeItem('clientName');
        // На всякий случай пробуем удалить jwt-куку на клиенте
        document.cookie = "jwt=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        // Редирект на страницу входа
        window.location.href = '/timeDelivery/'; // замените на ваш путь к странице логина
    });


    ///////////////////////////////

    const token = localStorage.getItem('token');
    let oldPhone = '';

    document.getElementById('offcanvasUserEdit').addEventListener('show.bs.offcanvas', async () => {
        try {
            const res = await fetch('/timeDelivery/user/me', {
                headers: {'Authorization': 'Bearer ' + token}
            });
            if (!res.ok) throw new Error('Ошибка загрузки данных пользователя');
            const user = await res.json();
            document.getElementById('userPhoneInput').value = user.phone || '';
            oldPhone = user.phone || '';

            // Очистка паролей
            document.getElementById('userPasswordCurrent').value = '';
            document.getElementById('userPasswordNew').value = '';
            document.getElementById('userPasswordNewCheck').value = '';
        } catch (e) {
            showUniversalToast('Ошибка', e.message, 'danger');
        }
    });


    document.getElementById('userEditForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const phone = document.getElementById('userPhoneInput').value.trim();
        const currentPassword = document.getElementById('userPasswordCurrent').value;
        const newPassword = document.getElementById('userPasswordNew').value;
        const newPasswordCheck = document.getElementById('userPasswordNewCheck').value;

        if (!currentPassword || currentPassword.length < 6) {
            showUniversalToast('Ошибка', 'Введите текущий пароль (минимум 6 символов)', 'warning');
            return;
        }

        if (newPassword || newPasswordCheck) {
            if (newPassword.length < 6) {
                showUniversalToast('Ошибка', 'Новый пароль должен быть не короче 6 символов', 'warning');
                return;
            }
            if (newPassword !== newPasswordCheck) {
                showUniversalToast('Ошибка', 'Новый пароль и его повтор не совпадают', 'warning');
                return;
            }
        }

        const payload = {
            phone,
            currentPassword,
            newPassword: newPassword ? newPassword : null
        };

        try {
            const res = await fetch('/user/update', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                const err = await res.text();
                throw new Error(err || 'Ошибка обновления данных');
            }

            if (phone !== oldPhone) {
                showUniversalToast('Внимание', 'Ваш логин был изменён. Пожалуйста, войдите в систему с новым логином.', 'info');
                await fetch('/timeDelivery/logout', {method: 'POST', credentials: 'include'});
                localStorage.removeItem('token');
                localStorage.removeItem('roles');
                localStorage.removeItem('clientName');
                window.location.href = '/timeDelivery/'; // путь к логину
                return;
            }

            showUniversalToast('Успех', 'Данные успешно обновлены', 'success');
            bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasUserEdit')).hide();

            // Очистка паролей после успешного обновления
            document.getElementById('userPasswordCurrent').value = '';
            document.getElementById('userPasswordNew').value = '';
            document.getElementById('userPasswordNewCheck').value = '';
        } catch (err) {
            showUniversalToast('Ошибка', err.message, 'danger');
        }
    });


    // --- Форма редактирования личных данных ---
    document.getElementById('offcanvasClientEdit').addEventListener('show.bs.offcanvas', async () => {
        try {
            const token = localStorage.getItem('token');
            const res = await fetch('/timeDelivery/me', {
                headers: {'Authorization': 'Bearer ' + token}
            });
            if (!res.ok) throw new Error('Ошибка загрузки Client данных');
            const client = await res.json();

            document.getElementById('clientNameInput').value = client.name || '';
            document.getElementById('clientEmailInput').value = client.email || '';
            document.getElementById('clientAddressInput').value = client.address || '';
            document.getElementById('clientCityInput').value = client.city || '';
            document.getElementById('clientBirthdayInput').value = client.birthday ? client.birthday.substring(0, 10) : '';
        } catch (e) {
            alert(e.message);
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const birthdayInput = document.getElementById('clientBirthdayInput');
        if (birthdayInput) {
            const today = new Date().toISOString().split('T')[0];
            birthdayInput.setAttribute('max', today);

            birthdayInput.addEventListener('input', () => {
                if (birthdayInput.value > birthdayInput.max) {
                    birthdayInput.setCustomValidity('Дата рождения не может быть в будущем');
                } else {
                    birthdayInput.setCustomValidity('');
                }
            });
        }
    });

    document.getElementById('clientEditForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('clientNameInput').value.trim();
        const email = document.getElementById('clientEmailInput').value.trim();
        const address = document.getElementById('clientAddressInput').value.trim();
        const city = document.getElementById('clientCityInput').value.trim();
        const birthday = document.getElementById('clientBirthdayInput').value;

        const payload = {name, email, address, city, birthday};

        try {
            const token = localStorage.getItem('token');
            const res = await fetch('/user/updateClient', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Ошибка обновления Client');

            bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasClientEdit')).hide();
            document.getElementById('clientName').textContent = name;
            localStorage.setItem('clientName', name);

            showUniversalToast('Успех', 'Client данные обновлены', 'success');
        } catch (e) {
            showUniversalToast('Ошибка', e.message, 'danger');
        }
    });

    //////////////////////////////////////////////////////
    // Функция для рендера таблицы заказов пользователя
    function renderUserOrdersTable(userOrders, allDishes) {
        const container = document.getElementById('userOrdersTableContainer');
        const emptyMessage = document.getElementById('userOrdersEmptyMessage');

        if (!userOrders || userOrders.length === 0) {
            container.innerHTML = '';
            emptyMessage.style.display = 'block';
            return;
        }

        emptyMessage.style.display = 'none';

        let html = '';

        userOrders.forEach(order => {
            if (!order.id) {
                console.warn('Пропущен заказ без id:', order);
                return;
            }

            let itemsRows = '';
            let total = 0;

            if (!Array.isArray(order.items) || order.items.length === 0) {
                itemsRows = `<tr><td colspan="5" class="text-center text-muted">В этом заказе нет товаров</td></tr>`;
            } else {
                order.items.forEach(item => {
                    if (!item.dishName || !item.price || !item.quantity) {
                        console.warn('Пропущен товар с неполными данными:', item);
                        return;
                    }
                    const sum = item.price * item.quantity;
                    total += sum;

                    const dish = allDishes.find(d => d.name === item.dishName);
                    const encodedImageUrl = dish ? '/photos' + encodeURI(dish.imageUrl) : '/photos/default.jpg';
                    const altText = dish ? dish.name : item.dishName;
                    const query = encodeURIComponent(altText);

                    itemsRows += `
                    <tr>
                        <td>
                            <a href="/timeDelivery/search?query=${query}" target="_blank" rel="noopener noreferrer">
                                <img src="${encodedImageUrl}" alt="${altText}" style="width:60px; height:40px; object-fit:cover; border-radius: 4px;">
                            </a>
                        </td>
                        <td>
                            <a href="/timeDelivery/search?query=${query}" class="link-black-no-underline" target="_blank" rel="noopener noreferrer">${altText}</a>
                        </td>
                        <td>${item.price} руб.</td>
                        <td>${item.quantity}</td>
                        <td>${sum} руб.</td>
                    </tr>
                `;
                });
            }

            html += `
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="order-number">Заказ №${order.id}</div>
                    <div><small class="order-number">Дата: ${new Date(order.createdAt).toLocaleString()}</small></div>
                    <div><span class="badge bg-info text-dark">${order.status || 'Неизвестен'}</span></div>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped align-middle mb-0">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Блюдо</th>
                                <th>Цена</th>
                                <th>Кол-во</th>
                                <th>Сумма</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsRows}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="text-end"><b>Итого:</b></td>
                                <td><b>${total} руб.</b></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        `;
        });

        container.innerHTML = html;
    }

    async function loadAndRenderUserOrders(userOrders) {
        const allDishes = await loadAllDishes();
        renderUserOrdersTable(userOrders, allDishes);
    }


    // Загрузка данных и вызов рендера при загрузке страницы
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('/timeDelivery/orders/userOrders', {
                credentials: 'include'
            });

            if (!response.ok) throw new Error(`Ошибка загрузки заказов: ${response.status} ${response.statusText}`);

            const userOrders = await response.json();

            if (!Array.isArray(userOrders)) {
                throw new Error('Некорректный формат данных заказов');
            }

            loadAndRenderUserOrders(userOrders);
        } catch (error) {
            console.error('Ошибка при загрузке заказов:', error);
            const container = document.getElementById('userOrdersTableContainer');
            container.innerHTML = '<p class="text-danger">Не удалось загрузить заказы.</p>';
            const emptyMessage = document.getElementById('userOrdersEmptyMessage');
            emptyMessage.style.display = 'none';
        }
    });


</script>

</body>
<footer class="footer-bg">
    <div class="container py-4">
        <div class="row gy-4 justify-content-center">
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="d-flex flex-column footer-boxes h-100">
                    <h5>О МИЯГИ</h5>
                    <span class="footer-text">Мы готовим кухню, которую ты захочешь попробовать снова.</span>
                    <button type="button" class="btn btn-outline-warning btn-footer mt-3"
                            onclick="window.location.href='/timeDelivery/restaurants'">Подробнее
                    </button>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-2">
                <div class="d-flex flex-column footer-boxes h-100">
                    <h5>О КОМПАНИИ</h5>
                    <a href="/timeDelivery/restaurants" class="footer-text">Контакты</a>
                    <a href="/timeDelivery/bonuses" class="footer-text">Бонусы и скидки</a>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-2">
                <div class="d-flex flex-column footer-boxes h-100">
                    <h5>ДОСТАВКА И ОПЛАТА</h5>
                    <a href="/timeDelivery/delivery" class="footer-text">Доставка</a>
                    <a href="/timeDelivery/payment" class="footer-text">Оплата</a>
                    <a href="/timeDelivery/pickup" class="footer-text">Самовывоз</a>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="d-flex flex-column footer-boxes h-100">
                    <h5>КОНТАКТНАЯ ИНФОРМАЦИЯ</h5>
                    <h5>+7 (978) 999-99-99</h5>
                    <h5>+7 (978) 555-55-55</h5>
                    <span class="footer-text">Время работы доставки: 10:00-02:00</span>
                    <span class="footer-text">Бесплатная доставка суши и пиццы по Севастополю.</span>
                    <span class="footer-text">г.Севастополь, ул. Олега Кошевого, 14А</span>
                    <span class="footer-text">г.Севастополь, ул. Фадеева, 48</span>
                </div>
            </div>
        </div>
    </div>
</footer>
</html>