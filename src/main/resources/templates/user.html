<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Страница пользователя</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
            crossorigin="anonymous"></script>
</head>
<style>
    /* форма входа и регистрации */
    .offcanvas {
        background-color: #222;
        color: #888;
        border-left: 1px solid #444;
    }

    .auth-form {
        max-width: 400px;
        margin: 2rem auto;
        padding: 2rem;
        background: #2a2a2a;
        border-radius: 1rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.2);
        color: #999;
        border: 1px solid #444;
    }

    .auth-switcher .btn-group {
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.2);
        border-radius: 0.75rem;
        overflow: hidden;
    }

    .auth-switcher .btn {
        border: none;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .auth-switcher .btn:not(.active) {
        background: #333;
        color: #f8f9fa;
    }

    .auth-switcher .btn.active {
        background: #0d6efd;
        color: #fff;
    }

    .form-control {
        background: #333;
        border: 1px solid #444;
        color: #f8f9fa;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .form-control:focus {
        background: #444;
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        color: #fff;
    }

    .form-control::placeholder {
        color: #eee; /* почти белый */
        opacity: 1;
    }

    .form-group label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #f8f9fa;
    }

    .toast {
        border-radius: 0.75rem;
    }

    .toast-header {
        border-radius: 0.75rem 0.75rem 0 0;
    }

    @media (max-width: 576px) {
        .auth-form {
            padding: 1.5rem;
        }
    }

    .toast {
        border-radius: 0.75rem;
        background: #2a2a2a;
        border: 1px solid #444;
        color: #eee;
    }

    .toast-header {
        border-radius: 0.75rem 0.75rem 0 0;
        background: #333;
        color: #eee;
        border-bottom: 1px solid #444;
    }

    .toast-body {
        background: #2a2a2a;
        color: #888;
    }

    /*футер*/
    .footer-bg {
        background-color: #222;
        width: 100%;
    }

    .footer-bg h5 {
        color: #ff9900;
        margin-bottom: 0.5rem;
    }

    .footer-text {
        color: #ccc;
        font-size: 0.97rem;
        margin-bottom: 0.5rem;
        text-decoration: none;
    }

    .footer .btn-footer {
        width: fit-content;
        align-self: flex-start;
    }

    a.footer-text:hover {
        color: #ff9900;
        text-decoration: underline;
    }

    .footer-text:hover {
        color: #ff9900;
    }

    body {
        font-family: "Times New Roman", Times, serif;
    }

    .custom-card {
        background-color: #222;
        color: #eee;
        border: 1px solid #444;
        border-radius: 1rem;
    }

    .custom-card .card-title {
        color: #ffd700;
        font-size: 1.2rem;
    }

    .btn-footer {
        border-radius: 0.5rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        font-size: 1.15rem; /* увеличенный размер шрифта */
    }

    .btn-outline-warning {
        color: #ffc107;
        border-color: #ffc107;
        background-color: transparent;
        transition: all 0.2s;
    }

    .btn-outline-warning:hover {
        background-color: #ffc107;
        color: #222;
        border-color: #ffc107;
    }

    .btn-outline-danger {
        color: #ff6b6b;
        border-color: #ff6b6b;
        background-color: transparent;
        transition: all 0.2s;
    }

    .btn-sm {
        padding: 0.25rem 0.75rem;
        font-size: 0.9rem;
    }

</style>
<body>
<h1>Добро пожаловать!</h1>

<div class="container" style="height: 700px">
    <div class="card mb-3 custom-card" style="width: 18rem;">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 id="clientName">Имя пользователя</h5>
                <button id="logoutBtn" class="btn btn-outline-danger btn-sm ms-2">Выйти</button>
            </div>
            <div class="d-grid gap-2 mb-2">
                <button id="BackBtn" class="btn btn-outline-warning btn-footer"
                        onclick="window.location.href='/timeDelivery/'">Назад
                </button>
                <button class="btn btn-outline-warning btn-footer" type="button" data-bs-toggle="offcanvas"
                        data-bs-target="#offcanvasUserEdit" aria-controls="offcanvasUserEdit">
                    Безопасность
                </button>
                <button class="btn btn-outline-warning btn-footer" type="button" data-bs-toggle="offcanvas"
                        data-bs-target="#offcanvasClientEdit" aria-controls="offcanvasClientEdit">
                    Контактные данные
                </button>
                <button id="ordersBtn" class="btn btn-outline-warning btn-footer">Заказы</button>
            </div>
        </div>
    </div>


    <div class="container mt-3">
        <!-- Offcanvas для редактирования пользователя -->
        <div class="offcanvas offcanvas-start" data-bs-scroll="true" tabindex="-1" id="offcanvasUserEdit"
             aria-labelledby="offcanvasUserEditLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasUserEditLabel">Безопасность</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
            </div>
            <div class="offcanvas-body">
                <form id="userEditForm" class="auth-form" novalidate>
                    <div class="mb-3">
                        <label for="userPhoneInput" class="form-label">Телефон:</label>
                        <input type="text" class="form-control" id="userPhoneInput" name="phone" required/>
                    </div>
                    <div class="mb-3">
                        <label for="userPasswordCurrent" class="form-label">Текущий пароль:</label>
                        <input type="password" class="form-control" id="userPasswordCurrent" name="currentPassword"
                               minlength="6" required/>
                    </div>
                    <div class="mb-3">
                        <label for="userPasswordNew" class="form-label">Новый пароль:</label>
                        <input type="password" class="form-control" id="userPasswordNew" name="newPassword"
                               minlength="6"/>
                    </div>
                    <div class="mb-3">
                        <label for="userPasswordNewCheck" class="form-label">Повторите новый пароль:</label>
                        <input type="password" class="form-control" id="userPasswordNewCheck" name="newPasswordCheck"
                               minlength="6"/>
                    </div>
                    <button type="submit" class="btn btn-success">Сохранить</button>
                </form>
            </div>
        </div>

        <!-- Offcanvas для редактирования client-->
        <div class="offcanvas offcanvas-start" data-bs-scroll="true" tabindex="-1" id="offcanvasClientEdit"
             aria-labelledby="offcanvasClientEditLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasClientEditLabel">Контактные данные</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
            </div>
            <div class="offcanvas-body">
                <form id="clientEditForm" class="auth-form">
                    <div class="mb-3 form-group">
                        <label for="clientNameInput" class="form-label">Имя</label>
                        <input type="text" class="form-control" id="clientNameInput" name="name" required/>
                    </div>
                    <div class="mb-3 form-group">
                        <label for="clientEmailInput" class="form-label">Email</label>
                        <input type="email" class="form-control" id="clientEmailInput" name="email" required/>
                    </div>
                    <div class="mb-3 form-group">
                        <label for="clientAddressInput" class="form-label">Адрес</label>
                        <input type="text" class="form-control" id="clientAddressInput" name="address"/>
                    </div>
                    <div class="mb-3 form-group">
                        <label for="clientCityInput" class="form-label">Город</label>
                        <input type="text" class="form-control" id="clientCityInput" name="city"/>
                    </div>
                    <div class="mb-3 form-group">
                        <label for="clientBirthdayInput" class="form-label">Дата рождения</label>
                        <input type="date" class="form-control" id="clientBirthdayInput" name="birthday"/>
                    </div>
                    <button type="submit" class="btn btn-success">Сохранить</button>
                </form>
            </div>
        </div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
            <div id="universalToast" class="toast align-items-center text-bg-dark border-0" role="alert"
                 aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
                <div class="toast-header">
                    <strong class="me-auto toast-title">Уведомление</strong>
                    <small>Система</small>
                    <button type="button" class="btn-close btn-close-white ms-2 mb-1" data-bs-dismiss="toast"
                            aria-label="Закрыть"></button>
                </div>
                <div class="toast-body">
                    Сообщение
                </div>
            </div>
        </div>


    </div>
</div>


<script>
    // Универсальная функция показа Toast
    function showUniversalToast(title, message, type = 'success') {
        const toastEl = document.getElementById('universalToast');
        const toastTitle = toastEl.querySelector('.toast-title');
        const toastBody = toastEl.querySelector('.toast-body');
        const toastHeader = toastEl.querySelector('.toast-header');

        // Сброс и установка классов для цвета
        toastEl.classList.remove('bg-success', 'bg-info', 'bg-warning', 'bg-danger');
        toastHeader.classList.remove('bg-success', 'bg-info', 'bg-warning', 'bg-danger');
        toastEl.classList.add('bg-' + type);
        toastHeader.classList.add('bg-' + type);

        toastTitle.textContent = title;
        toastBody.textContent = message;

        const toast = new bootstrap.Toast(toastEl);
        toast.show();

        setTimeout(() => toast.hide(), 5000);
    }

    // Например, если client.name хранится в localStorage:
    document.getElementById('clientName').textContent = localStorage.getItem('clientName') || 'Имя пользователя';

    // Или если получаете с сервера:
    fetch('/timeDelivery/me', {
        headers: {'Authorization': 'Bearer ' + localStorage.getItem('token')}
    })
        .then(res => res.json())
        .then(client => {
            document.getElementById('clientName').textContent = client.name || 'Имя пользователя';
        });


    //кнопка выхода
    document.getElementById('logoutBtn').addEventListener('click', async function (e) {
        e.preventDefault();
        try {
            // Вызов серверного logout для удаления httpOnly cookie
            await fetch('/timeDelivery/logout', {method: 'POST', credentials: 'include'});
        } catch (err) {
            // Можно обработать ошибку, если нужно
            console.error('Ошибка при выходе:', err);
        }
        // Очищаем localStorage
        localStorage.removeItem('token');
        localStorage.removeItem('roles');
        localStorage.removeItem('clientName');
        // На всякий случай пробуем удалить jwt-куку на клиенте
        document.cookie = "jwt=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        // Редирект на страницу входа
        window.location.href = '/timeDelivery/'; // замените на ваш путь к странице логина
    });


    ///////////////////////////////

    const token = localStorage.getItem('token');
    let oldPhone = '';

    document.getElementById('offcanvasUserEdit').addEventListener('show.bs.offcanvas', async () => {
        try {
            const res = await fetch('/timeDelivery/user/me', {
                headers: {'Authorization': 'Bearer ' + token}
            });
            if (!res.ok) throw new Error('Ошибка загрузки данных пользователя');
            const user = await res.json();
            document.getElementById('userPhoneInput').value = user.phone || '';
            oldPhone = user.phone || '';

            // Очистка паролей
            document.getElementById('userPasswordCurrent').value = '';
            document.getElementById('userPasswordNew').value = '';
            document.getElementById('userPasswordNewCheck').value = '';
        } catch (e) {
            showUniversalToast('Ошибка', e.message, 'danger');
        }
    });


    document.getElementById('userEditForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const phone = document.getElementById('userPhoneInput').value.trim();
        const currentPassword = document.getElementById('userPasswordCurrent').value;
        const newPassword = document.getElementById('userPasswordNew').value;
        const newPasswordCheck = document.getElementById('userPasswordNewCheck').value;

        if (!currentPassword || currentPassword.length < 6) {
            showUniversalToast('Ошибка', 'Введите текущий пароль (минимум 6 символов)', 'warning');
            return;
        }

        if (newPassword || newPasswordCheck) {
            if (newPassword.length < 6) {
                showUniversalToast('Ошибка', 'Новый пароль должен быть не короче 6 символов', 'warning');
                return;
            }
            if (newPassword !== newPasswordCheck) {
                showUniversalToast('Ошибка', 'Новый пароль и его повтор не совпадают', 'warning');
                return;
            }
        }

        const payload = {
            phone,
            currentPassword,
            newPassword: newPassword ? newPassword : null
        };

        try {
            const res = await fetch('/user/update', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                const err = await res.text();
                throw new Error(err || 'Ошибка обновления данных');
            }

            if (phone !== oldPhone) {
                showUniversalToast('Внимание', 'Ваш логин был изменён. Пожалуйста, войдите в систему с новым логином.', 'info');
                await fetch('/timeDelivery/logout', {method: 'POST', credentials: 'include'});
                localStorage.removeItem('token');
                localStorage.removeItem('roles');
                localStorage.removeItem('clientName');
                window.location.href = '/timeDelivery/'; // путь к логину
                return;
            }

            showUniversalToast('Успех', 'Данные успешно обновлены', 'success');
            bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasUserEdit')).hide();

            // Очистка паролей после успешного обновления
            document.getElementById('userPasswordCurrent').value = '';
            document.getElementById('userPasswordNew').value = '';
            document.getElementById('userPasswordNewCheck').value = '';
        } catch (err) {
            showUniversalToast('Ошибка', err.message, 'danger');
        }
    });


    // --- Форма редактирования личных данных ---
    document.getElementById('offcanvasClientEdit').addEventListener('show.bs.offcanvas', async () => {
        try {
            const token = localStorage.getItem('token');
            const res = await fetch('/timeDelivery/me', {
                headers: {'Authorization': 'Bearer ' + token}
            });
            if (!res.ok) throw new Error('Ошибка загрузки Client данных');
            const client = await res.json();

            document.getElementById('clientNameInput').value = client.name || '';
            document.getElementById('clientEmailInput').value = client.email || '';
            document.getElementById('clientAddressInput').value = client.address || '';
            document.getElementById('clientCityInput').value = client.city || '';
            document.getElementById('clientBirthdayInput').value = client.birthday ? client.birthday.substring(0, 10) : '';
        } catch (e) {
            alert(e.message);
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const birthdayInput = document.getElementById('clientBirthdayInput');
        if (birthdayInput) {
            const today = new Date().toISOString().split('T')[0];
            birthdayInput.setAttribute('max', today);

            birthdayInput.addEventListener('input', () => {
                if (birthdayInput.value > birthdayInput.max) {
                    birthdayInput.setCustomValidity('Дата рождения не может быть в будущем');
                } else {
                    birthdayInput.setCustomValidity('');
                }
            });
        }
    });

    document.getElementById('clientEditForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('clientNameInput').value.trim();
        const email = document.getElementById('clientEmailInput').value.trim();
        const address = document.getElementById('clientAddressInput').value.trim();
        const city = document.getElementById('clientCityInput').value.trim();
        const birthday = document.getElementById('clientBirthdayInput').value;

        const payload = {name, email, address, city, birthday};

        try {
            const token = localStorage.getItem('token');
            const res = await fetch('/user/updateClient', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Ошибка обновления Client');

            bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasClientEdit')).hide();
            document.getElementById('clientName').textContent = name;
            localStorage.setItem('clientName', name);

            showUniversalToast('Успех', 'Client данные обновлены', 'success');
        } catch (e) {
            showUniversalToast('Ошибка', e.message, 'danger');
        }
    });


</script>

</body>
<footer class="footer-bg">
    <div class="container py-4">
        <div class="row gy-4 justify-content-center">
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="d-flex flex-column footer-boxes h-100">
                    <h5>О МИЯГИ</h5>
                    <span class="footer-text">Мы готовим кухню, которую ты захочешь попробовать снова.</span>
                    <button type="button" class="btn btn-outline-warning btn-footer mt-3"
                            onclick="window.location.href='/timeDelivery/restaurants'">Подробнее
                    </button>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-2">
                <div class="d-flex flex-column footer-boxes h-100">
                    <h5>О КОМПАНИИ</h5>
                    <a href="/timeDelivery/restaurants" class="footer-text">Контакты</a>
                    <a href="/timeDelivery/bonuses" class="footer-text">Бонусы и скидки</a>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-2">
                <div class="d-flex flex-column footer-boxes h-100">
                    <h5>ДОСТАВКА И ОПЛАТА</h5>
                    <a href="/timeDelivery/delivery" class="footer-text">Доставка</a>
                    <a href="/timeDelivery/payment" class="footer-text">Оплата</a>
                    <a href="/timeDelivery/pickup" class="footer-text">Самовывоз</a>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="d-flex flex-column footer-boxes h-100">
                    <h5>КОНТАКТНАЯ ИНФОРМАЦИЯ</h5>
                    <h5>+7 (978) 999-99-99</h5>
                    <h5>+7 (978) 555-55-55</h5>
                    <span class="footer-text">Время работы доставки: 10:00-02:00</span>
                    <span class="footer-text">Бесплатная доставка суши и пиццы по Севастополю.</span>
                    <span class="footer-text">г.Севастополь, ул. Олега Кошевого, 14А</span>
                    <span class="footer-text">г.Севастополь, ул. Фадеева, 48</span>
                </div>
            </div>
        </div>
    </div>
</footer>
</html>